<!DOCTYPE html>
<html lang="en">
<head>
	<title>Chance Weasel</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="ext/bootstrap.min.css">
	<link rel="stylesheet" href="assets/style.css">
	<!-- <script src="cw.js"></script> -->
	<script src="ext/vue.js"></script>
	<script src="ext/jquery-3.5.1.min.js"></script>
	<script src="ext/lodash.js"></script>
	<script src="ext/popper.min.js"></script>
	<script src="ext/bootstrap.min.js"></script>
</head>

<body>
	<header class="header">
		<h1>La Belette de la Chance</h1>
	</header>
	<div id="cw">
		<div class="container-fluid upload-container">
			<div class="accordion" id="accordionExample">
				<div class="card">
					<div class="card-header" id="headingOne">
						<h2 class="mb-0">
							<button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
								1. Participants
							</button>
						</h2>
					</div>
			
					<div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
						<div class="card-body">
							<div class="input-group input-group-sm mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text" id="inputGroupFile1">Chargement des participants</span>
								</div>
								<div class="custom-file">
									<input type="file" class="custom-file-input" id="participantsFile" aria-describedby="inputGroupFileAddon01" @change="onFileUpload">
									<label class="custom-file-label" for="participantsFile">{{fileName1}}</label>
								</div>
							</div>
							<div>
								<span>Nb de participations: </span><span>{{nbLinesFile}}</span>
							</div>
							<div>
								<button type="button" class="btn btn-primary btn-sm" :disabled="nbLinesFile == 0" v-on:click="createTicketTable()">Création du fichier des tickets</button>
							</div>
							<div v-show="nbLinesFile != 0">
								<span>Nb de tickets créés: </span><span>{{nbTickets}}</span>
							</div>
							<div v-show="nbLinesFile != 0">
								<button type="button" class="btn btn-success btn-sm" :disabled="nbTickets == 0" v-on:click="exportToCSV(true)">Export du fichier des tickets</button>
							</div>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="card-header" id="headingTwo">
						<h2 class="mb-0">
							<button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
								2. Lots
							</button>
						</h2>
					</div>
					<div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
						<div class="card-body">
							<div class="input-group input-group-sm mb-3">
								<div class="input-group-prepend">
									<span class="input-group-text" id="inputGroupFile2">Chargement des lots</span>
								</div>
								<div class="custom-file">
									<input type="file" class="custom-file-input" id="lotsFile" aria-describedby="inputGroupFile2" @change="onFileUpload">
									<label class="custom-file-label" for="lotsFile">{{fileName2}}</label>
								</div>
								<div>
									<span>Nb de lignes du fichier: </span><span>{{lotsList.length}}</span>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="card">
					<div class="card-header" id="headingThree">
						<h2 class="mb-0">
							<button class="btn btn-link btn-block text-left collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
								3. Tirage
							</button>
						</h2>
					</div>
					<div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
						<div class="card-body">
							<button type="button" class="btn btn-danger btn-sm" :disabled="nbTickets == 0" v-on:click="tirage()">Tirage</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script>
	var cw = new Vue({
		el: '#cw',
		data: {
			nbLinesFile: 0,
			nbTickets: 0,
			participantList: [],
			lotsList: [],
			ticketTable: [],
			finalTable: [],
			fileName1: 'Choose file',
			fileName2: 'Choose file',
			message: 'Chance Weasel'
		},
		mounted() {

		},
		methods: {
			onFileUpload(p_event) {
				var files = p_event.target.files || p_event.dataTransfer.files
				if (!files.length) return
				if ( event.currentTarget.id == "participantsFile" ) this.createInput(files[0], 'participantList', 'fileName1')
				if ( event.currentTarget.id == "lotsFile" ) this.createInput(files[0], 'lotsList', 'fileName2')
			},
			createInput(p_file, p_table, p_fileInput) {
				this[p_fileInput] = p_file.name
				let promise = new Promise((resolve, reject) => {

					var reader = new FileReader();
					var vm = this;
					reader.onload = e => {
						resolve((vm.fileinput = reader.result));
					}
					reader.readAsText(p_file)
				})

				promise.then(
					result => {
						this.parseFile(this.fileinput, p_table)
					},
					error => {
						console.log(error);
					}
				)
			},
			parseFile(p_csv, p_table) {
				var file = p_csv.split('\n')
				var table = []
				var header = file[0].split(';')

				for(var i = 1; i < file.length; i++) {

					var obj = {};
					var currentline = file[i].split(";")

					for(var j = 0; j < header.length; j++) {
						obj[header[j]] = currentline[j]
					}
					if (currentline != '') table.push(obj)
				}
				table.splice(0,2)
				this.nbLinesFile = table.length
				this[p_table] = table
			},
			createTicketTable() {
				var tableTirage = []
				_.forEach(this.participantList, function(line) {
					if ( line['Tarif'] != undefined ) {
						var nbTicket = line['Tarif'].replace(/[^0-9\.]+/g, '')
						nbTicket = parseInt(nbTicket, 10)
						var url = line['Url billet'].split('ticketId=')
						var params = url[1].split('&ag=')
						var ticketID = params[0]
						var i = 0
						do {
							i = i + 1
							var newLine = {'ticketID': ticketID + '-' + i, 'out': false }
							tableTirage.push(newLine)
						} while (i < nbTicket)
					}
				})
				// debugger
				this.ticketTable = tableTirage
				this.nbTickets = this.ticketTable.length
			},
			exportToCSV(p_header) {
				debugger
				// If JSONData is not an object then JSON.parse will parse the JSON string in an Object
				var arrData = typeof this.ticketTable != 'object' ? JSON.parse(this.ticketTable) : this.ticketTable
				var CSV = ''

				// This condition will generate the Label/Header
				if (p_header) {
					var row = ""

					// This loop will extract the label from 1st index of on array
					for (var index in arrData[0]) {
					// Now convert each value to string and comma-seprated
						row += index + ';'
					}
					row = row.slice(0, -1)
					// Append Label row with line break
					CSV += row + '\r\n'
				}

				// 1st loop is to extract each row
				for (var i = 0; i < arrData.length; i++) {
						var row = ""
						// 2nd loop will extract each column and convert it in string comma-seprated
						for (var index in arrData[i]) {
								row += '' + arrData[i][index] + ';'
						}
						row.slice(0, row.length - 1)
						// Add a line break after each row
						CSV += row + '\r\n'
				}

				// if (CSV == '') {
				// 		alert("Invalid data")
				// 		return
				// }

				// This trick will generate a temp "a" tag
				var link = document.createElement("a")
				link.id = "lnkDwnldLnk"

				// This part will append the anchor tag and remove it after automatic click
				document.body.appendChild(link)

				var csv = CSV
				blob = new Blob([csv], { type: 'text/csv' })
				var csvUrl = window.webkitURL.createObjectURL(blob)
				var filename = 'Tickets.csv'
				$("#lnkDwnldLnk").attr({ 'download': filename, 'href': csvUrl })

				$('#lnkDwnldLnk')[0].click()
				document.body.removeChild(link)
			},
			tirage() {
				
			}
		}
	})
</script>
</html>