<!DOCTYPE html>
<html lang="en">
<head>
	<title>Chance Weasel</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="ext/bootstrap.min.css">
	<link rel="stylesheet" href="assets/style.css">
	<script src="cw.js"></script>
	<script src="ext/vue.js"></script>
	<script src="ext/jquery-3.5.1.min.js"></script>
	<script src="ext/lodash.js"></script>
	<script src="ext/popper.min.js"></script>
	<script src="ext/bootstrap.min.js"></script>
</head>

<body>
	<header class="header">
		<h1>La Belette de la Chance</h1>
	</header>
	<div id="cw">
		<div class="container-fluid upload-container">
			<div class="input-group input-group-sm mb-3">
				<div class="input-group-prepend">
					<span class="input-group-text" id="inputGroupFile1">Chargement des participants</span>
				</div>
				<div class="custom-file">
					<input type="file" class="custom-file-input" id="participantsFile" aria-describedby="inputGroupFileAddon01" @change="onFileUpload">
					<label class="custom-file-label" for="participantsFile">{{fileInput}}</label>
				</div>
			</div>
			<div>
				<span>Nb de lignes du fichier: </span><span>{{nbLinesFile}}</span>
				<button type="button" class="btn btn-primary btn-sm" :disabled="nbLinesFile == 0" v-on:click="createTicketTable()">Création du fichier des tickets</button>
			</div>
			<div>
				<span>Nb de tickets créés: </span><span>{{nbTickets}}</span>
				<button type="button" class="btn btn-success btn-sm" :disabled="nbTickets == 0" v-on:click="exportToCSV()">Export du fichier des tickets</button>
				<button type="button" class="btn btn-danger btn-sm" :disabled="nbTickets == 0" v-on:click="tirage()">Tirage</button>
			</div>
			<div class="input-group input-group-sm mb-3">
				<div class="input-group-prepend">
					<span class="input-group-text" id="inputGroupFile2">Chargement des lots</span>
				</div>
				<div class="custom-file">
					<input type="file" class="custom-file-input" id="lotsFile" aria-describedby="inputGroupFile2" @change="onFileChange">
					<label class="custom-file-label" for="lotsFile">{{fileInput}}</label>
				</div>
			</div>
		</div>
	</div>
</body>
<!-- <script src="cw.js"></script>
<script src="ext/vue.js"></script>
<script src="ext/jquery-3.5.1.min.js"></script>
<script src="ext/lodash.js"></script>
<script src="ext/popper.min.js"></script>
<script src="ext/bootstrap.min.js"></script> -->
<script>
	var cw = new Vue({
		el: '#cw',
		data: {
			nbLinesFile: 0,
			nbTickets: 0,
			csvTable: [],
			ticketTable: [],
			finalTable: [],
			fileInput: 'Choose file',
			message: 'Chance Weasel'
		},
		mounted() {

		},
		methods: {
			onFileUpload(event) {
				console.log(event)
				debugger
				var files = event.target.files || event.dataTransfer.files
				if (!files.length) return
				if ( event.currentTarget.id == "participantsFile" ) this.createInput(files[0])
				if ( event.currentTarget.id == "lotsFile" ) this.createInput(files[0])

			},
			createInput(file) {
				// console.log(file)
				this.fileInput = file.name
				let promise = new Promise((resolve, reject) => {

					var reader = new FileReader();
					var vm = this;
					reader.onload = e => {
						resolve((vm.fileinput = reader.result));
					}
					reader.readAsText(file);
				})

				promise.then(
					result => {
						this.parseFile(this.fileinput)
					},
					error => {
						/* handle an error */ 
						console.log(error);
					}
				)
			},
			parseFile(csv) {

				var file = csv.split('\n')
				var table = []
				var header = file[0].split(';')
				// console.log(header)

				for(var i = 1; i < file.length; i++) {

					var obj = {};
					var currentline = file[i].split(";")

					for(var j = 0; j < header.length; j++) {
						obj[header[j]] = currentline[j]
					}
					table.push(obj)
				}
				table.splice(0,2)
				this.nbLinesFile = table.length
				this.csvTable = table
				// console.table(table)
				// this.processTable(table)
			},
			createTicketTable() {
				var tableTirage = []
				// debugger
				_.forEach(this.csvTable, function(line) {
					// debugger
					if ( line['Tarif'] != undefined ) {
						var nbTicket = line['Tarif'].replace(/[^0-9\.]+/g, '')
						nbTicket = parseInt(nbTicket, 10)
						var url = line['Url billet'].split('ticketId=')
						var params = url[1].split('&ag=')
						var ticketID = params[0]
						var i = 0
						do {
							i = i + 1
							var newLine = {'ticketID': ticketID + '-' + i, 'out': false }
							tableTirage.push(newLine)
						} while (i < nbTicket)
					}
				})
				debugger
				this.ticketTable = tableTirage
				this.nbTickets = tableTirage.length
			},
			tirage() {
				
			}
		}
	})
</script>
</html>